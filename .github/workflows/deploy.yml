name: Build and Deploy to Netlify

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout portfolio
        uses: actions/checkout@v4
        with:
          path: portfolio

      - name: Checkout full-of-noise
        uses: actions/checkout@v4
        with:
          repository: cloutphilled/full-of-noise
          path: full-of-noise

      - name: Checkout TELOS
        uses: actions/checkout@v4
        with:
          repository: cloutphilled/TELOS
          path: TELOS

      - name: Checkout SEMLER-frontend
        uses: actions/checkout@v4
        with:
          repository: cloutphilled/SEMLER-frontend
          path: SEMLER-frontend

      - name: Checkout it-support-docs
        uses: actions/checkout@v4
        with:
          repository: cloutphilled/it-support-docs
          path: it-support-docs

      - name: Checkout angular-pokemon-app
        uses: actions/checkout@v4
        with:
          repository: cloutphilled/angular-pokemon-app
          path: angular-pokemon-app

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            portfolio/package-lock.json
            it-support-docs/package-lock.json
            angular-pokemon-app/package-lock.json

      - name: Install portfolio dependencies
        run: npm ci
        working-directory: portfolio

      - name: Install it-support-docs dependencies
        run: npm ci
        working-directory: it-support-docs

      - name: Install angular-pokemon-app dependencies
        run: npm ci
        working-directory: angular-pokemon-app

      - name: Copy static projects
        run: |
          mkdir -p public/projects
          cp -r ../SEMLER-frontend public/projects/semler-frontend
          cp -r ../TELOS public/projects/telos
          cp -r ../full-of-noise public/projects/full-of-noise
        working-directory: portfolio

      - name: Build it-support-docs
        run: npm run docs:build
        working-directory: it-support-docs
        env:
          VITEPRESS_BASE: /projects/it-support-docs/

      - name: Copy it-support-docs build
        run: cp -r ../it-support-docs/docs/.vitepress/dist public/projects/it-support-docs
        working-directory: portfolio

      - name: Build angular-pokemon-app
        run: npx ng build --base-href=/projects/angular-pokemon-app/
        working-directory: angular-pokemon-app

      - name: Copy angular-pokemon-app build
        run: cp -r ../angular-pokemon-app/dist/ng-pokemontrainer public/projects/angular-pokemon-app
        working-directory: portfolio

      - name: Inject back button into project HTML files
        run: |
          BACK_BUTTON='<a href="/projects" id="portfolio-back-btn" onclick="window.location.href='"'"'/projects'"'"';return false;" style="position:fixed;top:16px;left:16px;z-index:99999;background:#1a1a1a;color:#fff;padding:8px 16px;border-radius:8px;text-decoration:none;font-family:system-ui,sans-serif;font-size:14px;display:flex;align-items:center;gap:6px;box-shadow:0 2px 8px rgba(0,0,0,0.3);" onmouseover="this.style.background='"'"'#333'"'"'" onmouseout="this.style.background='"'"'#1a1a1a'"'"'"><img src="/077Ponyta.png" style="width:24px;height:24px;object-fit:contain;" alt="" /> Portfolio</a>'
          find public/projects -name "*.html" -type f | while read file; do
            if ! grep -q "portfolio-back-btn" "$file"; then
              sed -i "s|</body>|${BACK_BUTTON}</body>|" "$file"
            fi
          done
        working-directory: portfolio

      - name: Build portfolio
        run: npm run build
        working-directory: portfolio

      - name: Debug - List dist contents
        run: |
          echo "=== dist/projects contents ==="
          ls -la dist/projects/ || echo "No projects folder!"
          echo "=== dist/projects subfolders ==="
          ls -la dist/projects/*/ || echo "No subfolders!"
        working-directory: portfolio

      - name: Deploy to Netlify
        run: |
          npm install -g netlify-cli
          netlify deploy --prod --dir=dist --site=${{ secrets.NETLIFY_SITE_ID }} --auth=${{ secrets.NETLIFY_AUTH_TOKEN }}
        working-directory: portfolio
